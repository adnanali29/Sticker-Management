<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia Jiya Stickers - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow-x: hidden;
        }

        html, body {
            height: 100%;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .card-modern {
            background: white;
            border-radius: 16px;
            border-left: 6px solid;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-modern:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .login-card {
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.98), rgba(20, 20, 40, 0.98));
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5), 0 0 100px rgba(102, 126, 234, 0.3);
            position: relative;
        }

        .login-card::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            z-index: -1;
            opacity: 0.7;
            filter: blur(20px);
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% {
                opacity: 0.7;
                filter: blur(20px);
            }
            50% {
                opacity: 1;
                filter: blur(30px);
            }
        }

        .header-bar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            margin: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(56, 239, 125, 0.4);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        input, select, textarea {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stat-card {
            border-radius: 16px;
            padding: 24px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .center-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .scrollable-content {
            overflow-y: auto;
            /* Updated height calculation */
            height: calc(100vh - 120px); 
        }

        .stock-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .stock-item-row {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .stock-item-row:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
    </style>
</head>
<body class="h-full">
    
    <div id="app" class="min-h-full"></div>

    <footer class="bg-gray-900/90 backdrop-blur-lg border-t border-gray-700/50 p-2 mt-auto">
        <div class="text-center">
            <p class="text-gray-400 text-xs" id="footer-text">All rights reserved by Pixel Web Pages ¬© 2025</p>
        </div>
    </footer>

    <script>
        // Phase 2 will start here

        // --- Configuration and State ---
        const supabaseUrl = 'https://unlwaejexohabnbnnkrw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVubHdhZWpleG9oYWJuYm5ua3J3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MjU2ODgsImV4cCI6MjA3ODAwMTY4OH0.qXoNkloB2WLazjqZNKkFox1i2yVE_NOrOr9vSwM6ex0';
        let supabaseClient;

        // Data state
        let allData = []; // This will hold all our data (stock, vendors, history)
        let currentView = 'login';
        let currentPassword  // Your original password
        let isLoggedIn = false;

        // New UI variants
        let sheetTypeVariants = ['Paper Gumming', 'NT Opec', 'Silver Sticker', 'Golden Sticker', 'Transparent'];
        let stickerTypeVariants = ['Long Front', 'Long Back', 'Square Back', 'Die-Cut Front'];

        // New UI configuration (hardcoded from new file)
        const defaultConfig = {
            system_title: 'Sticker Management System',
            company_name: 'Chia Jiya Stickers',
            admin_email: 'adnan@addyfitness.com',
            footer_text: 'All rights reserved by Pixel Web Pages',
            primary_color: '#667eea',
            secondary_color: '#764ba2',
            accent_color: '#f093fb',
            text_color: '#1a1a2e',
            success_color: '#10b981'
        };
        // Helper to get config values
        function getConfig() {
            return defaultConfig;
        }

        // --- Supabase and App Initialization ---

        async function loadData() {
            try {
                const [invRes, vendRes, transRes] = await Promise.all([
                    supabaseClient.from('inventory').select('*').order('name', { ascending: true }),
                    supabaseClient.from('vendors').select('*').order('name', { ascending: true }),
                    supabaseClient.from('transactions').select('*').order('date', { ascending: false }).order('time', { ascending: false })
                ]);

                if (invRes.error) throw invRes.error;
                if (vendRes.error) throw vendRes.error;
                if (transRes.error) throw transRes.error;

                allData = []; // Clear existing data

                // Map Supabase 'inventory' table (old schema) to app data
                invRes.data.forEach(item => {
                    allData.push({
                        // We use the 'stock' type for the new UI's logic
                        type: 'stock', 
                        id: item.id,
                        productName: item.name,
                        sheetType: item.sheet_type,
                        stickerType: item.sticker_type,
                        // CRITICAL: We map 'pieces' to 'totalPieces' for our internal logic
                        // And we calculate 'numberOfSheets' for display, which is what the new UI uses.
                        // The new UI logic is based on 'numberOfSheets', so we must adapt our 'pieces'-based schema.
                        pieces: item.pieces, // Store original 'pieces'
                        piecesPerSheet: item.pieces_per_sheet,
                        costPerSheet: parseFloat(item.cost_per_sheet),
                        totalCost: parseFloat(item.total_cost), // Store original 'total_cost'
                        vendor: item.vendor,
                        date: item.date_added,
                        timestamp: new Date(item.date_added).toISOString()
                    });
                });
                
                // Map Supabase 'vendors' table (old schema) to app data (new schema)
                vendRes.data.forEach(item => {
                    allData.push({
                        type: 'vendor',
                        id: item.id,
                        vendorName: item.name,      // Map 'name' to 'vendorName'
                        pocName: item.contact,    // Map 'contact' to 'pocName'
                        phoneNumber: item.phone,    // Map 'phone' to 'phoneNumber'
                        email: item.email,
                        city: item.city,
                        state: item.state,
                        address: item.address,
                        // Add new fields as empty strings to match new UI
                        website: item.website || '', 
                        country: item.country || 'India',
                        notes: item.notes || '',
                        timestamp: new Date(item.created_at || Date.now()).toISOString()
                    });
                });

                // Map Supabase 'transactions' table (old schema) to app data ('history' type)
                transRes.data.forEach(item => {
                    allData.push({
                        type: 'history',
                        id: item.id,
                        stockId: item.product_id, // Map 'product_id' to 'stockId'
                        action: item.type === 'Stock In' ? 'stock_in' : 'stock_out', // Map 'type'
                        quantity: item.quantity,
                        valueChange: item.cost, // Map 'cost' to 'valueChange'
                        // Reconstruct timestamp for sorting
                        timestamp: new Date(item.date + ' ' + item.time).toISOString(),
                        // Add new fields for compatibility
                        beforeQuantity: item.beforeQuantity || 0, // Default if not in old schema
                        afterQuantity: item.afterQuantity || 0, // Default if not in old schema
                        dateAdded: item.date
                    });
                });

            } catch (error) {
                console.error('Failed to load data from Supabase:', error.message);
                showToast('Failed to load data from Supabase.', 'error');
                allData = [];
            }
        }

        async function initApp() {
            try {
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase library not loaded.');
                }
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Supabase client created successfully.');
                
                // Set footer text from config
                document.getElementById('footer-text').textContent = `${getConfig().footer_text} ¬© 2025`;
                
                // This replaces the old DOMContentLoaded listener
                // We don't need to load data here, login will do it.
                renderCurrentView();

            } catch (error) {
                console.error('Failed to initialize app:', error);
                document.getElementById('app').innerHTML = `<div class="center-container"><div class="login-card p-12 w-full max-w-md text-white">Error: ${error.message}</div></div>`;
            }
        }

        // --- New Rendering Engine ---

        function renderCurrentView() {
            const app = document.getElementById('app');
            
            // We must call this to ensure footer text is set
            const config = getConfig();
            document.getElementById('footer-text').textContent = `${config.footer_text} ¬© 2025`;

            if (!isLoggedIn) {
                if (currentView === 'login') {
                    app.innerHTML = renderLogin();
                } else if (currentView === 'forgot-password') {
                    app.innerHTML = renderForgotPassword();
                }
            } else {
                if (currentView === 'dashboard') {
                    app.innerHTML = renderDashboard();
                } else if (currentView === 'total-stock') {
                    app.innerHTML = renderTotalStock();
                } else if (currentView === 'stock-value') {
                    app.innerHTML = renderStockValue();
                } else if (currentView === 'vendors') {
                    app.innerHTML = renderVendors();
                } else if (currentView === 'add-vendor') {
                    app.innerHTML = renderAddVendor();
                } else if (currentView === 'stock-in') {
                    app.innerHTML = renderStockIn();
                } else if (currentView === 'stock-out') {
                    // This view is no longer a page, it's a popup
                    // So we default to dashboard if it's ever called
                    app.innerHTML = renderDashboard();
                }
            }
        }

        // Calculate total stock value from our 'pieces' and 'cost' data
        function calculateTotalStockValue() {
            const stockItems = allData.filter(d => d.type === 'stock');
            // We use 'totalCost' from our old schema, which is more accurate
            return stockItems.reduce((sum, item) => sum + (item.totalCost || 0), 0);
        }

        // Calculate total pieces from our 'pieces' data
        function calculateTotalStockPieces() {
            const stockItems = allData.filter(d => d.type === 'stock');
            return stockItems.reduce((sum, item) => sum + (item.pieces || 0), 0);
        }

        function renderStockCard(item, config) {
            // We use 'item.pieces' from our Supabase schema
            const totalPieces = item.pieces; 
            // We use 'item.totalCost' from our Supabase schema
            const totalValue = item.totalCost; 
            const costPerPiece = item.piecesPerSheet > 0 ? item.costPerSheet / item.piecesPerSheet : 0;
            
            const isOutOfStock = totalPieces === 0;
            const isLowStock = totalPieces > 0 && totalPieces <= 20;
            const borderColor = isOutOfStock ? '#ef4444' : isLowStock ? '#f97316' : (config.primary_color || defaultConfig.primary_color);
            const borderStyle = isOutOfStock
                ? 'border: 3px solid #ef4444;'
                : isLowStock
                ? 'border: 3px solid #f97316;'
                : `border-left-color: ${borderColor};`;

            return `
            <div class="card-modern p-6" style="${borderStyle} position: relative;">
                <button onclick="deleteStockItem('${item.id}')" class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-500 text-sm font-bold transition-colors rounded-full hover:bg-red-50" title="Delete Stock">
                    ‚úï
                </button>

                ${isLowStock ? `
                <div class="mb-3 px-3 py-2 rounded-lg text-center" style="background: #fef3c7; border: 2px solid #f59e0b;">
                    <span class="text-xs font-bold" style="color: #d97706;">‚ö†Ô∏è LOW STOCK - Reorder Soon!</span>
                </div>
                ` : ''}

                ${isOutOfStock ? `
                <div class="mb-3 px-3 py-2 rounded-lg text-center" style="background: #fee2e2; border: 2px solid #ef4444;">
                    <span class="text-xs font-bold" style="color: #dc2626;">üö´ OUT OF STOCK</span>
                </div>
                ` : ''}

                <div class="flex justify-between items-start mb-4 pr-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${item.productName}</h3>
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2" style="background: rgba(102, 126, 234, 0.1); color: ${config.primary_color || defaultConfig.primary_color}">
                            ${item.sheetType} - ${item.stickerType}
                        </span>
                    </div>
                </div>

                <div class="space-y-2 text-sm mb-4 flex-grow">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Vendor:</span>
                        <span class="font-semibold text-gray-800">${item.vendor}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Stock:</span>
                        <span class="font-bold text-lg" style="color: ${isOutOfStock ? '#ef4444' : isLowStock ? '#f59e0b' : config.primary_color || defaultConfig.primary_color}">${totalPieces} pcs</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Value:</span>
                        <span class="font-bold text-lg" style="color: ${config.secondary_color || defaultConfig.secondary_color}">‚Çπ${totalValue.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cost Per Piece:</span>
                        <span class="font-semibold text-gray-800">‚Çπ${costPerPiece.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Date Added:</span>
                        <span class="font-semibold text-gray-800">${new Date(item.date).toLocaleDateString()}</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="stockInItem('${item.id}')" class="btn-success text-white py-2 rounded-lg text-sm font-semibold">
                        üì• Stock In
                    </button>
                    <button onclick="stockOutItem('${item.id}')" class="btn-danger text-white py-2 rounded-lg text-sm font-semibold">
                        üì§ Stock Out
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="editStockItem('${item.id}')" class="btn-primary text-white py-2 rounded-lg text-sm font-semibold">
                        ‚úèÔ∏è Edit
                    </button>
                    <button onclick="viewHistory('${item.id}')" class="text-white py-2 rounded-lg text-sm font-semibold" style="background: #6366f1;">
                        üìú History
                    </button>
                </div>

                <div>
                    <button onclick="quickStockOut('${item.id}')" class="w-full text-white py-2 rounded-lg text-sm font-semibold" style="background: ${isOutOfStock ? '#ef4444' : '#f97316'};">
                        ${isOutOfStock ? 'üö´ Out of Stock' : 'üì§ Quick Stock Out'}
                    </button>
                </div>
            </div>
            `;
        }

        function renderLogin() {
            const config = getConfig();
            return `
            <div class="center-container">
                <div class="login-card p-12 w-full max-w-md">
                    <div class="text-center mb-8">
                        <div class="text-7xl mb-4">ü•§</div>
                        <h1 class="text-4xl font-bold mb-3 text-white">
                            ${config.company_name || defaultConfig.company_name}
                        </h1>
                        <p class="text-xl font-semibold text-white text-opacity-90">Admin Dashboard</p>
                    </div>

                    <form onsubmit="handleLogin(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-white">Email</label>
                            <input
                                type="email"
                                id="login-email"
                                class="w-full px-4 py-3 rounded-xl"
                                placeholder="Enter your email"
                                value=""
                                required
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-white">Password</label>
                            <div class="relative">
                                <input
                                    type="password"
                                    id="login-password"
                                    class="w-full px-4 py-3 rounded-xl"
                                    placeholder="Enter password"
                                    required
                                />
                                <button
                                    type="button"
                                    onclick="togglePasswordVisibility('login-password', 'login-eye-icon')"
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <span id="login-eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="w-full text-white font-semibold py-3 rounded-xl" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.3);">
                            Login
                        </button>

                        <button type="button" onclick="showForgotPassword()" class="w-full text-center text-sm font-medium text-white hover:text-opacity-80 transition-all">
                            Forgot Password?
                        </button>
                    </form>
                </div>
            </div>
            `;
        }
        
        function renderDashboard() {
            const config = getConfig();
            const stockItems = allData.filter(d => d.type === 'stock');
            const vendors = allData.filter(d => d.type === 'vendor');
            
            // Use our new calculation functions
            const totalPieces = calculateTotalStockPieces();
            const totalValue = calculateTotalStockValue();

            return `
            <div style="height: 100%; display: flex; flex-direction: column;">
                <div class="header-bar px-8 py-5">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">ü•§</span>
                            <div>
                                <h1 class="text-2xl sm:text-3xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">${config.system_title || defaultConfig.system_title}</h1>
                                <p class="text-gray-500 text-sm">${config.company_name || defaultConfig.company_name}</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="confirmReset()" class="px-4 sm:px-6 py-2.5 text-white rounded-xl font-semibold text-sm sm:text-base" style="background: #f97316;">
                                üîÑ Reset
                            </button>
                            <button onclick="handleLogout()" class="btn-danger px-4 sm:px-6 py-2.5 text-white rounded-xl font-semibold text-sm sm:text-base">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>

                <div class="scrollable-content px-3 sm:px-6">
                    <div class="mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div onclick="navigateTo('total-stock')" class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold">Total Stock</h3>
                                    <span class="text-4xl">üì¶</span>
                                </div>
                                <p class="text-4xl font-bold">${totalPieces}</p>
                                <p class="text-sm opacity-90 mt-2">Pieces Available in Stock</p>
                            </div>

                            <div onclick="navigateTo('stock-value')" class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold">Stock Value</h3>
                                    <span class="text-4xl">üí∞</span>
                                </div>
                                <p class="text-4xl font-bold">‚Çπ${totalValue.toFixed(2)}</p>
                                <p class="text-sm opacity-90 mt-2">Total Inventory Value</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold">Vendors</h3>
                                    <span class="text-4xl">üë•</span>
                                </div>
                                <p class="text-4xl font-bold">${vendors.length}</p>
                                <p class="text-sm opacity-90 mb-4">Active Suppliers</p>
                                <div class="flex gap-2">
                                    <button onclick="navigateTo('add-vendor')" class="flex-1 py-2 rounded-lg text-sm font-semibold bg-white text-purple-600 hover:bg-opacity-90 transition-all">
                                        ‚ûï Add
                                    </button>
                                    <button onclick="navigateTo('vendors')" class="flex-1 py-2 rounded-lg text-sm font-semibold bg-white text-purple-600 hover:bg-opacity-90 transition-all">
                                        üëÅÔ∏è View
                                    </button>
                                </div>
                            </div>

                            <div class="stat-card" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-lg font-semibold">Stock Management</h3>
                                    <span class="text-4xl">üìä</span>
                                </div>
                                <p class="text-xs opacity-90 mb-4">Add or Remove Stock</p>
                                <p class="text-4xl font-bold mb-4">&nbsp;</p>
                                <div class="flex gap-2">
                                    <button onclick="navigateTo('stock-in')" class="flex-1 py-2 rounded-lg text-sm font-semibold bg-white text-orange-600 hover:bg-opacity-90 transition-all">
                                        üì• In
                                    </button>
                                    <button onclick="showStockOutPopup()" class="flex-1 py-2 rounded-lg text-sm font-semibold bg-white text-orange-600 hover:bg-opacity-90 transition-all">
                                        üì§ Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-4 sm:p-8 mb-8">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-3">
                            <h2 class="text-2xl sm:text-3xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">üì¶ Current Inventory</h2>
                            <p class="text-gray-600 font-medium">${stockItems.length} items in stock</p>
                        </div>

                        ${stockItems.length > 0 ? `
                        <div class="stock-card-grid">
                            ${stockItems.map(item => renderStockCard(item, config)).join('')}
                        </div>
                        ` : `
                        <div class="text-center py-16">
                            <span class="text-8xl mb-6 block">üì¶</span>
                            <p class="text-gray-600 text-xl mb-2 font-semibold">No inventory items yet</p>
                            <p class="text-gray-500 text-sm mb-8">Start by adding your first stock entry</p>
                            <button onclick="navigateTo('stock-in')" class="btn-primary px-10 py-4 text-white rounded-xl font-semibold inline-block text-lg">
                                ‚ûï Add First Stock Item
                            </button>
                        </div>
                        `}
                    </div>
                </div>
            </div>
            `;
        }

        function renderTotalStock() {
            const config = getConfig();
            const stockItems = allData.filter(d => d.type === 'stock');

            return `
            <div style="height: 100%; display: flex; flex-direction: column;">
                <div class="header-bar px-8 py-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">üì¶</span>
                            <div>
                                <h1 class="text-3xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">Total Stock</h1>
                                <p class="text-gray-500 text-sm">All inventory items</p>
                            </div>
                        </div>
                        <button onclick="navigateTo('dashboard')" class="btn-primary px-6 py-2.5 text-white rounded-xl font-semibold">
                            ‚Üê Back to Dashboard
                        </button>
                    </div>
                </div>

                <div class="scrollable-content px-6">
                    ${stockItems.length > 0 ? `
                    <div class="stock-card-grid">
                        ${stockItems.map(item => renderStockCard(item, config)).join('')}
                    </div>
                    ` : `
                    <div class="text-center py-16">
                        <span class="text-8xl mb-6 block">üì¶</span>
                        <p class="text-gray-600 text-xl">No stock items yet. Add your first stock entry!</p>
                    </div>
                    `}
                </div>
            </div>
            `;
        }
        function renderStockValue() {
            const config = getConfig();
            const stockItems = allData.filter(d => d.type === 'stock');

            const stickerTypeTotals = {};
            let grandTotalValue = 0;
            let grandTotalPieces = 0;

            stockItems.forEach(item => {
                if (!stickerTypeTotals[item.stickerType]) {
                    stickerTypeTotals[item.stickerType] = {
                        pieces: 0,
                        value: 0
                    };
                }
                // Use our schema's values
                const totalPieces = item.pieces;
                const totalValue = item.totalCost;

                stickerTypeTotals[item.stickerType].pieces += totalPieces;
                stickerTypeTotals[item.stickerType].value += totalValue;

                grandTotalValue += totalValue;
                grandTotalPieces += totalPieces;
            });

            return `
            <div style="height: 100%; display: flex; flex-direction: column;">
                <div class="header-bar px-8 py-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">üí∞</span>
                            <div>
                                <h1 class="text-3xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">Stock Value</h1>
                                <p class="text-gray-500 text-sm">Detailed value breakdown</p>
                            </div>
                        </div>
                        <button onclick="navigateTo('dashboard')" class="btn-primary px-6 py-2.5 text-white rounded-xl font-semibold">
                            ‚Üê Back to Dashboard
                        </button>
                    </div>
                </div>

                <div class="scrollable-content px-6">
                    <div class="mb-8">
                        <div class="glass-card p-6 max-w-md mx-auto">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">üí∞ Total Stock Value</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-4 rounded-xl" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                    <p class="text-white text-xs mb-1 opacity-90">Total Pieces</p>
                                    <p class="text-white text-3xl font-bold">${grandTotalPieces}</p>
                                </div>
                                <div class="text-center p-4 rounded-xl" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                                    <p class="text-white text-xs mb-1 opacity-90">Total Value</p>
                                    <p class="text-white text-3xl font-bold">‚Çπ${grandTotalValue.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${Object.keys(stickerTypeTotals).length > 0 ? `
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4 text-white">üìä Summary by Sticker Type</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            ${Object.entries(stickerTypeTotals).map(([type, totals]) => `
                            <div class="p-3 rounded-lg" style="background: white; border-left: 3px solid ${config.primary_color || defaultConfig.primary_color}; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1)">
                                <h3 class="text-sm font-bold mb-2 text-gray-800">${type}</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Pieces:</span>
                                        <span class="font-semibold text-gray-800">${totals.pieces}</span>
                                    </div>
                                    <div class="flex justify-between pt-1 border-t border-gray-200">
                                        <span class="text-gray-600">Value:</span>
                                        <span class="font-bold" style="color: ${config.secondary_color || defaultConfig.secondary_color}">‚Çπ${totals.value.toFixed(0)}</span>
                                    </div>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <h2 class="text-2xl font-bold mb-6 text-white">üì¶ Detailed Stock Information</h2>
                    ${stockItems.length > 0 ? `
                    <div class="stock-card-grid">
                        ${stockItems.map(item => renderStockCard(item, config)).join('')}
                    </div>
                    ` : `
                    <div class="text-center py-16">
                        <span class="text-8xl mb-6 block">üí∞</span>
                        <p class="text-gray-600 text-xl">No stock items to display</p>
                    </div>
                    `}
                </div>
            </div>
            `;
        }

        function renderVendors() {
            const config = getConfig();
            const vendors = allData.filter(d => d.type === 'vendor');

            return `
            <div style="height: 100%; display: flex; flex-direction: column;">
                <div class="header-bar px-8 py-5">
                    <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-4">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">üë•</span>
                            <div>
                                <h1 class="text-3xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">All Vendors</h1>
                                <p class="text-gray-500 text-sm">Manage your vendor relationships</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="downloadVendorTemplate()" class="px-3 py-2 text-white rounded-lg text-xs font-semibold" style="background: #8b5cf6;">
                                üìÑ Template
                            </button>
                            <button onclick="downloadVendorsCSV()" class="px-3 py-2 text-white rounded-lg text-xs font-semibold" style="background: #10b981;">
                                üì• Download
                            </button>
                            <button onclick="uploadVendorsCSV()" class="px-3 py-2 text-white rounded-lg text-xs font-semibold" style="background: #f59e0b;">
                                üì§ Upload
                            </button>
                            <button onclick="navigateTo('add-vendor')" class="btn-success px-3 py-2 text-white rounded-lg text-xs font-semibold">
                                ‚ûï Add
                            </button>
                            <button onclick="navigateTo('dashboard')" class="btn-primary px-3 py-2 text-white rounded-lg text-xs font-semibold">
                                ‚Üê Back
                            </button>
                        </div>
                    </div>
                </div>

                <div class="scrollable-content px-6">
                    <div class="stock-card-grid">
                        ${vendors.map(vendor => `
                        <div class="card-modern p-6" style="border-left-color: ${config.primary_color || defaultConfig.primary_color}">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-gray-800">${vendor.vendorName}</h3>
                                <span class="text-3xl">üè¢</span>
                            </div>

                            <div class="space-y-2 text-sm mb-4 flex-grow">
                                <p class="text-gray-700"><strong>POC:</strong> ${vendor.pocName}</p>
                                <p class="text-gray-700"><strong>Phone:</strong> ${vendor.phoneNumber}</p>
                                <p class="text-gray-700"><strong>Email:</strong> ${vendor.email}</p>
                                ${vendor.website ? `<p class="text-gray-700"><strong>Website:</strong> <a href="${vendor.website}" target="_blank" class="text-blue-600 hover:underline">${vendor.website}</a></p>` : ''}
                                <p class="text-gray-700"><strong>Address:</strong> ${vendor.address}</p>
                                ${vendor.city ? `<p class="text-gray-700"><strong>City:</strong> ${vendor.city}</p>` : ''}
                                ${vendor.state ? `<p class="text-gray-700"><strong>State:</strong> ${vendor.state}</p>` : ''}
                                ${vendor.country ? `<p class="text-gray-700"><strong>Country:</strong> ${vendor.country}</p>` : ''}
                                ${vendor.notes ? `<p class="text-gray-700"><strong>Notes:</strong> ${vendor.notes}</p>` : ''}
                            </div>

                            <div class="flex gap-2">
                                <button onclick="editVendor('${vendor.id}')" class="flex-1 btn-primary text-white py-2 rounded-lg text-sm font-semibold">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="deleteVendor('${vendor.id}')" class="flex-1 btn-danger text-white py-2 rounded-lg text-sm font-semibold">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        `).join('')}
                    </div>

                    ${vendors.length === 0 ? `
                    <div class="text-center py-16">
                        <span class="text-8xl mb-6 block">üë•</span>
                        <p class="text-gray-500 text-xl mb-2 font-semibold">No vendors yet</p>
                        <p class="text-gray-500 text-sm mb-8">Add your first vendor to get started</p>
                        <button onclick="navigateTo('add-vendor')" class="btn-success px-10 py-4 text-white rounded-xl font-semibold inline-block text-lg">
                            ‚ûï Add First Vendor
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
            `;
        }

        function renderAddVendor() {
            const config = getConfig();
            return `
            <div style="height: 100%; display: flex; flex-direction: column;">
                <div class="header-bar px-8 py-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">‚ûï</span>
                            <div>
                                <h1 class="text-3xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">Add Vendor</h1>
                                <p class="text-gray-500 text-sm">Enter vendor details</p>
                            </div>
                        </div>
                        <button onclick="navigateTo('dashboard')" class="btn-primary px-6 py-2.5 text-white rounded-xl font-semibold">
                            ‚Üê Back to Dashboard
                        </button>
                    </div>
                </div>

                <div class="scrollable-content px-6">
                    <div class="glass-card p-6 max-w-2xl mx-auto">
                        <form onsubmit="handleAddVendor(event)" class="space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Vendor Name *</label>
                                    <input
                                        type="text"
                                        id="vendor-name"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">POC Name *</label>
                                    <input
                                        type="text"
                                        id="poc-name"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Phone Number *</label>
                                    <input
                                        type="tel"
                                        id="phone-number"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Email *</label>
                                    <input
                                        type="email"
                                        id="vendor-email"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Website</label>
                                    <input
                                        type="url"
                                        id="vendor-website"
                                        placeholder="https://example.com"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                    />
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Address *</label>
                                    <input
                                        type="text"
                                        id="vendor-address"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">City *</label>
                                    <input
                                        type="text"
                                        id="vendor-city"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">State *</label>
                                    <select id="vendor-state" class="w-full px-3 py-2 rounded-lg text-sm" required>
                                        <option value="">Select State</option>
                                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                                        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                        <option value="Assam">Assam</option>
                                        <option value="Bihar">Bihar</option>
                                        <option value="Chhattisgarh">Chhattisgarh</option>
                                        <option value="Goa">Goa</option>
                                        <option value="Gujarat">Gujarat</option>
                                        <option value="Haryana">Haryana</option>
                                        <option value="Himachal Pradesh">Himachal Pradesh</option>
                                        <option value="Jharkhand">Jharkhand</option>
                                        <option value="Karnataka">Karnataka</option>
                                        <option value="Kerala">Kerala</option>
                                        <option value="Madhya Pradesh">Madhya Pradesh</option>
                                        <option value="Maharashtra">Maharashtra</option>
                                        <option value="Manipur">Manipur</option>
                                        <option value="Meghalaya">Meghalaya</option>
                                        <option value="Mizoram">Mizoram</option>
                                        <option value="Nagaland">Nagaland</option>
                                        <option value="Odisha">Odisha</option>
                                        <option value="Punjab">Punjab</option>
                                        <option value="Rajasthan">Rajasthan</option>
                                        <option value="Sikkim">Sikkim</option>
                                        <option value="Tamil Nadu">Tamil Nadu</option>
                                        <option value="Telangana">Telangana</option>
                                        <option value="Tripura">Tripura</option>
                                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                                        <option value="Uttarakhand">Uttarakhand</option>
                                        <option value="West Bengal">West Bengal</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Country *</label>
                                    <select id="vendor-country" class="w-full px-3 py-2 rounded-lg text-sm" required>
                                        <option value="India" selected>India</option>
                                    </select>
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Notes</label>
                                    <textarea
                                        id="vendor-notes"
                                        class="w-full px-3 py-2 rounded-lg text-sm"
                                        rows="2"
                                    >
                                    </textarea>

                                    </div>
                            </div>

                            <button type="submit" class="btn-success w-full text-white font-semibold py-3 rounded-xl mt-4">
                                ‚ûï Add Vendor
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            `;
        }

        function renderStockIn() {
            const config = getConfig();
            const vendors = allData.filter(d => d.type === 'vendor');

            return `
            <div style="height: 100%; display: flex; flex-direction: column;">
                <div class="header-bar px-8 py-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">üì•</span>
                            <div>
                                <h1 class="text-3xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">Stock In</h1>
                                <p class="text-gray-500 text-sm">Add new stock entry</p>
                            </div>
                        </div>
                        <button onclick="navigateTo('dashboard')" class="btn-primary px-6 py-2.5 text-white rounded-xl font-semibold">
                            ‚Üê Back to Dashboard
                        </button>
                    </div>
                </div>

                <div class="scrollable-content px-6">
                    <div class="glass-card p-8 max-w-3xl mx-auto">
                        <form onsubmit="handleStockIn(event)" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Product Name *</label>
                                    <input
                                        type="text"
                                        id="product-name"
                                        class="w-full px-4 py-3 rounded-xl"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Date *</label>
                                    <input
                                        type="date"
                                        id="stock-date"
                                        class="w-full px-4 py-3 rounded-xl"
                                        value="${new Date().toISOString().split('T')[0]}"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Sheet Type *</label>
                                    <select id="sheet-type" class="w-full px-4 py-3 rounded-xl" required onchange="handleSheetTypeChange()">
                                        <option value="">Select Sheet Type</option>
                                        ${sheetTypeVariants.map(type => `<option value="${type}">${type}</option>`).join('')}
                                        <option value="__add_new__">+ Add New Variant</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Sticker Type *</label>
                                    <select id="sticker-type" class="w-full px-4 py-3 rounded-xl" required onchange="handleStickerTypeChange()">
                                        <option value="">Select Sticker Type</option>
                                        ${stickerTypeVariants.map(type => `<option value="${type}">${type}</option>`).join('')}
                                        <option value="__add_new__">+ Add New Variant</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Number of Sheets *</label>
                                    <input
                                        type="number"
                                        id="number-of-sheets"
                                        class="w-full px-4 py-3 rounded-xl"
                                        min="1"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Pieces per Sheet *</label>
                                    <input
                                        type="number"
                                        id="pieces-per-sheet"
                                        class="w-full px-4 py-3 rounded-xl"
                                        min="1"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Cost per Sheet *</label>
                                    <input
                                        type="number"
                                        id="cost-per-sheet"
                                        class="w-full px-4 py-3 rounded-xl"
                                        min="0"
                                        step="0.01"
                                        required
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">Vendor *</label>
                                    <select id="stock-vendor" class="w-full px-4 py-3 rounded-xl" required>
                                        <option value="">Select Vendor</option>
                                        ${vendors.map(v => `<option value="${v.vendorName}">${v.vendorName}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <button type="submit" class="btn-success w-full text-white font-semibold py-4 rounded-xl text-lg">
                                üì• Add Stock
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            `;
        }

        // This page is no longer needed as the new UI uses a popup
        // We keep the function here but it won't be called
        function renderStockOut() {
            return renderDashboard(); // Just render dashboard as fallback
        }

        // --- App Logic (Adapted for Supabase) ---

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const loginButton = event.target.querySelector('button[type="submit"]');
            loginButton.textContent = 'Logging in...';
            loginButton.disabled = true;

            // Fetch the user from the database
            const { data: user, error } = await supabaseClient
                .from('users')
                .select('password')
                .eq('email', email)
                .single(); // Get a single user

            if (error || !user) {
                showToast('Email not found or database error.', 'error');
                loginButton.textContent = 'Login';
                loginButton.disabled = false;
                return;
            }

            // Check the plaintext password
            if (password === user.password) {
                isLoggedIn = true;
                currentView = 'dashboard';
                await loadData(); // Load data from Supabase AFTER successful login
                renderCurrentView();
                showToast('Login successful! Welcome back üéâ', 'success');
            } else {
                showToast('Incorrect password. Please try again.', 'error');
                loginButton.textContent = 'Login';
                loginButton.disabled = false;
            }
        }
        function showForgotPassword() {
            currentView = 'forgot-password';
            renderCurrentView();
        }

        function backToLogin() {
            currentView = 'login';
            renderCurrentView();
        }

        // Adapted from your OLD file's logic
        async function handleForgotPassword(event) {
            event.preventDefault();
            const config = getConfig();
            const email = document.getElementById('reset-email').value;
            const newPasswordSection = document.getElementById('new-password-section');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const submitButton = event.target.querySelector('button[type="submit"]');

            // Check if user is in the verification stage
            if (newPasswordSection.style.display === 'none') {
                if (email.toLowerCase() !== (config.admin_email || defaultConfig.admin_email).toLowerCase()) {
                    showToast('Email not authorized for password reset', 'error');
                    return;
                }
                
                // Check if email exists in DB (though we only allow admin)
                const { data: user, error } = await supabaseClient
                    .from('users')
                    .select('id')
                    .eq('email', email)
                    .single();

                if (error || !user) {
                    showToast('Admin user not found in database.', 'error');
                    return;
                }

                // Show password fields
                newPasswordSection.style.display = 'block';
                submitButton.textContent = 'Reset Password';
                showToast('Email verified! Enter new password', 'success');
            
            } else {
                // User is in the reset stage
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                if (newPassword !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }

                // --- Password Convention Check ---
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*])(?=.{8,})/;
                if (!passwordRegex.test(newPassword)) {
                    showToast('Password must be 8+ chars, with uppercase, lowercase, number, and special character (!@#$%^&*)', 'error');
                    return;
                }
                // --- End Check ---

                submitButton.textContent = 'Resetting...';
                submitButton.disabled = true;

                // Update the password in Supabase
                const { error } = await supabaseClient
                    .from('users')
                    .update({ password: newPassword }) // Storing plaintext
                    .eq('email', email);

                if (error) {
                    showToast(`Failed to update password: ${error.message}`, 'error');
                    submitButton.textContent = 'Reset Password';
                    submitButton.disabled = false;
                } else {
                    showToast('Password reset successful! üéâ', 'success');
                    currentView = 'login';
                    renderCurrentView();
                }
            }
        }

        function handleLogout() {
            isLoggedIn = false;
            currentView = 'login';
            allData = []; // Clear data on logout
            renderCurrentView();
            showToast('Logged out successfully. See you soon! üëã', 'success');
        }

        // --- Reset Logic (Adapted for Supabase) ---

        function confirmReset() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">‚ö†Ô∏è Confirm Reset</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to reset all data?
                This action cannot be undone and will delete all stock items, vendors, and history.</p>
                <div class="flex gap-3">
                    <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                        Cancel
                    </button>
                    <button id="confirmResetBtn" onclick="handleReset()" class="btn-danger flex-1 text-white py-3 rounded-xl font-semibold">
                        Reset All Data
                    </button>
                </div>
            </div>
            `;
            document.body.appendChild(modal);
        }

        // This is from your OLD file's `confirmReset` function
        async function handleReset() {
            const resetButton = document.getElementById('confirmResetBtn');
            if(resetButton) {
                resetButton.textContent = 'Resetting...';
                resetButton.disabled = true;
            }
            
            try {
                await supabaseClient.from('transactions').delete().neq('id', 0);
                await supabaseClient.from('inventory').delete().neq('id', 0);
                await supabaseClient.from('vendors').delete().neq('id', 0);
                
                await loadData(); // Reload the (now empty) data
                
                document.querySelector('.modal-backdrop')?.remove();
                showToast('All data has been successfully deleted!', 'success');
                renderCurrentView(); // Re-render dashboard
                
            } catch (error) {
                console.error('Failed to reset data:', error.message);
                showToast('Failed to reset data. Check console for details.', 'error');
                if(resetButton) {
                    resetButton.textContent = 'Reset All Data';
                    resetButton.disabled = false;
                }
            }
        }

        function navigateTo(view) {
            currentView = view;
            renderCurrentView();
        }

        // --- Vendor Management (Adapted for Supabase) ---

        async function handleAddVendor(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.textContent = 'Adding...';
            submitButton.disabled = true;
            
            // Map new form fields to old Supabase schema
            const vendorData = {
                name: document.getElementById('vendor-name').value,
                contact: document.getElementById('poc-name').value,
                phone: document.getElementById('phone-number').value,
                email: document.getElementById('vendor-email').value,
                address: document.getElementById('vendor-address').value,
                city: document.getElementById('vendor-city').value,
                state: document.getElementById('vendor-state').value,
                // New fields that might not be in your old schema, but we include them.
                // Supabase ignores columns that don't exist.
                website: document.getElementById('vendor-website').value,
                country: document.getElementById('vendor-country').value,
                notes: document.getElementById('vendor-notes').value
            };

            const { error } = await supabaseClient
                .from('vendors')
                .insert([vendorData]);

            if (error) {
                showToast(`Failed to add vendor: ${error.message}`, 'error');
                submitButton.textContent = '‚ûï Add Vendor';
                submitButton.disabled = false;
            } else {
                showToast('Vendor added successfully! üéâ', 'success');
                await loadData();
                navigateTo('vendors');
            }
        }

        function editVendor(vendorId) {
            const vendor = allData.find(d => d.id == vendorId);
            if (!vendor) return;

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-3xl w-full my-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">‚úèÔ∏è Edit Vendor</h2>
                <form onsubmit="updateVendor(event, '${vendorId}')" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Vendor Name *</label>
                            <input type="text" id="edit-vendor-name" value="${vendor.vendorName}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">POC Name *</label>
                            <input type="text" id="edit-poc-name" value="${vendor.pocName}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Phone Number *</label>
                            <input type="tel" id="edit-phone-number" value="${vendor.phoneNumber}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Email *</label>
                            <input type="email" id="edit-vendor-email" value="${vendor.email}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Website</label>
                            <input type="url" id="edit-vendor-website" value="${vendor.website || ''}" class="w-full px-4 py-3 rounded-xl" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Address *</label>
                            <input type="text" id="edit-vendor-address" value="${vendor.address}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">City *</label>
                            <input type="text" id="edit-vendor-city" value="${vendor.city || ''}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">State *</label>
                            <select id="edit-vendor-state" class="w-full px-4 py-3 rounded-xl" required>
                                 <option value="">Select State</option>
                                ${['Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal'].map(state => `<option value="${state}" ${vendor.state === state ? 'selected' : ''}>${state}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Country *</label>
                            <select id="edit-vendor-country" class="w-full px-4 py-3 rounded-xl" required>
                                <option value="India" ${vendor.country === 'India' ? 'selected' : ''}>India</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Notes</label>
                        <textarea id="edit-vendor-notes" class="w-full px-4 py-3 rounded-xl" rows="3">${vendor.notes || ''}</textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl font-semibold">
                            Update Vendor
                        </button>
                    </div>
                </form>
            </div>
            `;
            document.body.appendChild(modal);
        }
        async function updateVendor(event, vendorId) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.textContent = 'Updating...';
            submitButton.disabled = true;

            // Map form fields to Supabase schema
            const updatedVendor = {
                name: document.getElementById('edit-vendor-name').value,
                contact: document.getElementById('edit-poc-name').value,
                phone: document.getElementById('edit-phone-number').value,
                email: document.getElementById('edit-vendor-email').value,
                website: document.getElementById('edit-vendor-website').value,
                address: document.getElementById('edit-vendor-address').value,
                city: document.getElementById('edit-vendor-city').value,
                state: document.getElementById('edit-vendor-state').value,
                country: document.getElementById('edit-vendor-country').value,
                notes: document.getElementById('edit-vendor-notes').value
            };

            const { error } = await supabaseClient
                .from('vendors')
                .update(updatedVendor)
                .eq('id', vendorId);

            if (error) {
                showToast(`Failed to update vendor: ${error.message}`, 'error');
                submitButton.textContent = 'Update Vendor';
                submitButton.disabled = false;
            } else {
                showToast('Vendor updated successfully! ‚úÖ', 'success');
                document.querySelector('.modal-backdrop')?.remove();
                await loadData();
                renderCurrentView();
            }
        }

        async function deleteVendor(vendorId) {
            const vendor = allData.find(d => d.id == vendorId);
            if (!vendor) return;

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üóëÔ∏è Confirm Delete</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to delete vendor "<strong>${vendor.vendorName}</strong>"? This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                        Cancel
                    </button>
                    <button id="confirmDeleteBtn" onclick="confirmDeleteVendor('${vendorId}')" class="btn-danger flex-1 text-white py-3 rounded-xl font-semibold">
                        Delete
                    </button>
                </div>
            </div>
            `;
            document.body.appendChild(modal);
        }

        async function confirmDeleteVendor(vendorId) {
            const deleteButton = document.getElementById('confirmDeleteBtn');
            if(deleteButton) {
                deleteButton.textContent = 'Deleting...';
                deleteButton.disabled = true;
            }
            
            const { error } = await supabaseClient
                .from('vendors')
                .delete()
                .eq('id', vendorId);

            if (error) {
                showToast(`Failed to delete vendor: ${error.message}`, 'error');
                if(deleteButton) {
                    deleteButton.textContent = 'Delete';
                    deleteButton.disabled = false;
                }
            } else {
                showToast('Vendor deleted successfully! üóëÔ∏è', 'success');
                document.querySelector('.modal-backdrop')?.remove();
                await loadData();
                renderCurrentView();
            }
        }

        // --- CSV Features (Adapted for Supabase) ---

        function downloadVendorTemplate() {
            // We use the new schema's headers for the template
            const headers = ['Vendor Name', 'POC Name', 'Phone Number', 'Email', 'Website', 'Address', 'City', 'State', 'Country', 'Notes'];
            const sampleData = [
                '"ABC Suppliers"', '"John Doe"', '"+91-9876543210"', '"john@abcsuppliers.com"', '"https://abcsuppliers.com"', '"123 Main Street"', '"Mumbai"', '"Maharashtra"', '"India"', '"Reliable supplier"'
            ];

            const csvContent = [
                headers.join(','),
                sampleData.join(',')
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vendor_template.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('Vendor template downloaded! Fill it and upload üìÑ', 'success');
        }

        function downloadVendorsCSV() {
            const vendors = allData.filter(d => d.type === 'vendor');

            if (vendors.length === 0) {
                showToast('No vendors to download', 'error');
                return;
            }

            const headers = ['Vendor Name', 'POC Name', 'Phone Number', 'Email', 'Website', 'Address', 'City', 'State', 'Country', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...vendors.map(v => [
                    `"${v.vendorName}"`,
                    `"${v.pocName}"`,
                    `"${v.phoneNumber}"`,
                    `"${v.email}"`,
                    `"${v.website || ''}"`,
                    `"${v.address}"`,
                    `"${v.city || ''}"`,
                    `"${v.state || ''}"`,
                    `"${v.country || ''}"`,
                    `"${v.notes || ''}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vendors_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('Vendors CSV downloaded successfully! üì•', 'success');
        }

        function uploadVendorsCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const csv = event.target.result;
                    const lines = csv.split('\n');
                    // Headers line is lines[0]
                    
                    let errorCount = 0;
                    let vendorsToInsert = [];

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;

                        // Basic CSV parse (won't handle commas inside quotes)
                        const values = lines[i].split(','); 

                        if (values.length < 4) {
                            errorCount++;
                            continue;
                        }

                        // Map CSV columns to Supabase schema
                        const vendorData = {
                            name: values[0] ? values[0].trim().replace(/"/g, '') : '',
                            contact: values[1] ? values[1].trim().replace(/"/g, '') : '',
                            phone: values[2] ? values[2].trim().replace(/"/g, '') : '',
                            email: values[3] ? values[3].trim().replace(/"/g, '') : '',
                            website: values[4] ? values[4].trim().replace(/"/g, '') : '',
                            address: values[5] ? values[5].trim().replace(/"/g, '') : '',
                            city: values[6] ? values[6].trim().replace(/"/g, '') : '',
                            state: values[7] ? values[7].trim().replace(/"/g, '') : '',
                            country: values[8] ? values[8].trim().replace(/"/g, '') : '',
                            notes: values[9] ? values[9].trim().replace(/"/g, '') : '',
                        };
                        
                        // Basic validation
                        if(vendorData.name && vendorData.contact && vendorData.phone && vendorData.email) {
                            vendorsToInsert.push(vendorData);
                        } else {
                            errorCount++;
                        }
                    }

                    if(vendorsToInsert.length > 0) {
                        const { error } = await supabaseClient
                            .from('vendors')
                            .insert(vendorsToInsert);
                        
                        if (error) {
                            showToast(`Import failed: ${error.message}`, 'error');
                        } else {
                            showToast(`Successfully imported ${vendorsToInsert.length} vendors! üéâ`, 'success');
                            await loadData();
                            renderCurrentView();
                        }
                    } else if (errorCount > 0) {
                        showToast(`Failed to parse ${errorCount} vendors (check required fields)`, 'error');
                    } else {
                        showToast('No valid vendors found in file', 'info');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- Stock Management (Adapted for Supabase) ---

        async function logHistory(stockId, productName, action, quantity, beforePieces, afterPieces, valueChange, dateAdded = null) {
            // We map our new logic to the OLD 'transactions' table schema
            const transaction = {
                product_id: stockId,
                type: action === 'stock_in' ? 'Stock In' : 'Stock Out',
                product_name: productName,
                quantity: quantity,
                date: dateAdded || new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('en-US', { hour12: false }),
                cost: valueChange,
                // We can't store before/after pieces in the old schema
                // Supabase will ignore these if columns don't exist
                beforeQuantity: beforePieces,
                afterQuantity: afterPieces
            };

            const { error } = await supabaseClient
                .from('transactions')
                .insert([transaction]);
                
            if (error) {
                console.error('Failed to log history:', error.message);
                showToast('Failed to log transaction', 'error');
            }
        }

        async function handleStockIn(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.textContent = 'Adding...';
            submitButton.disabled = true;

            const productName = document.getElementById('product-name').value;
            let sheetType = document.getElementById('sheet-type').value;
            let stickerType = document.getElementById('sticker-type').value;
            const piecesPerSheet = parseInt(document.getElementById('pieces-per-sheet').value);
            const costPerSheet = parseFloat(document.getElementById('cost-per-sheet').value);
            const vendor = document.getElementById('stock-vendor').value;
            const numberOfSheets = parseInt(document.getElementById('number-of-sheets').value);
            const date = document.getElementById('stock-date').value;
            
            // Handle custom types
            if (sheetType === '__add_new__' || stickerType === '__add_new__') {
                showToast('Please add the new variant first', 'error');
                submitButton.textContent = 'üì• Add Stock';
                submitButton.disabled = false;
                return; // Stop execution
            }

            const totalPiecesToAdd = numberOfSheets * piecesPerSheet;
            const totalCostToAdd = numberOfSheets * costPerSheet;
            const costPerPiece = (piecesPerSheet > 0) ? costPerSheet / piecesPerSheet : 0;

            // Check for existing item to update
            const existingStock = allData.find(d =>
                d.type === 'stock' &&
                d.productName.toLowerCase() === productName.toLowerCase() &&
                d.sheetType === sheetType &&
                d.stickerType === stickerType &&
                d.piecesPerSheet === piecesPerSheet &&
                d.costPerSheet === costPerSheet &&
                d.vendor === vendor
            );

            if (existingStock) {
                // --- UPDATE EXISTING STOCK ---
                const beforePieces = existingStock.pieces;
                const newPieces = existingStock.pieces + totalPiecesToAdd;
                // Recalculate totalCost based on pieces
                const newTotalCost = newPieces * costPerPiece; 
                
                const { error } = await supabaseClient
                    .from('inventory')
                    .update({ 
                        pieces: newPieces, 
                        total_cost: newTotalCost,
                        date_added: date // Update date to latest
                    })
                    .eq('id', existingStock.id);
                
                if (error) {
                    showToast(`Failed to update stock: ${error.message}`, 'error');
                    submitButton.textContent = 'üì• Add Stock';
                    submitButton.disabled = false;
                } else {
                    await logHistory(existingStock.id, productName, 'stock_in', totalPiecesToAdd, beforePieces, newPieces, totalCostToAdd, date);
                    showToast(`Added ${numberOfSheets} sheets to existing stock! üì¶`, 'success');
                    await loadData();
                    navigateTo('dashboard');
                }

            } else {
                // --- CREATE NEW STOCK ---
                const stockData = {
                    name: productName,
                    date_added: date,
                    sheet_type: sheetType,
                    sticker_type: stickerType,
                    pieces: totalPiecesToAdd, // Store total pieces
                    pieces_per_sheet: piecesPerSheet,
                    cost_per_sheet: costPerSheet,
                    total_cost: totalCostToAdd, // Store total cost
                    vendor: vendor
                };

                const { data, error } = await supabaseClient
                    .from('inventory')
                    .insert([stockData])
                    .select(); // Get the new item back to log its ID
                    
                if (error) {
                    showToast(`Failed to add stock: ${error.message}`, 'error');
                    submitButton.textContent = 'üì• Add Stock';
                    submitButton.disabled = false;
                } else {
                    const newItemId = data[0].id;
                    await logHistory(newItemId, productName, 'stock_in', totalPiecesToAdd, 0, totalPiecesToAdd, totalCostToAdd, date);
                    showToast('New stock item created successfully! üéâ', 'success');
                    await loadData();
                    navigateTo('dashboard');
                }
            }
        }

        // --- New Stock Out UI (Popup) ---

        function showStockOutPopup() {
            const config = getConfig();
            const stockItems = allData.filter(d => d.type === 'stock' && d.pieces > 0);

            if (stockItems.length === 0) {
                showToast('No stock items available for stock out', 'error');
                return;
            }

            const currentTotalValue = calculateTotalStockValue();

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
            <div class="glass-card p-4 sm:p-8 max-w-4xl w-full my-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">üì§ Stock Out - Select Items</h2>
                    <button onclick="this.closest('.modal-backdrop').remove()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>

                <div class="mb-6 p-6 rounded-xl" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <div class="text-center">
                        <p class="text-white text-sm mb-2 opacity-90">Current Total Stock Value</p>
                        <p class="text-white text-4xl font-bold">‚Çπ${currentTotalValue.toFixed(2)}</p>
                    </div>
                </div>

                <div class="mb-6 p-4 rounded-xl" style="background: #fef3c7; border: 2px solid #f59e0b;">
                    <p class="text-sm font-semibold text-gray-800 text-center">
                        üí° Select items below and enter quantities to remove. The value will be deducted in real-time.
                    </p>
                </div>

                <div id="stock-out-list" class="space-y-3 mb-6 max-h-64 sm:max-h-96 overflow-y-auto">
                    ${stockItems.map(item => {
                        const costPerPiece = item.piecesPerSheet > 0 ? item.costPerSheet / item.piecesPerSheet : 0;
                        const totalPieces = item.pieces; // Use 'pieces' from schema
                        const totalValue = item.totalCost; // Use 'totalCost' from schema

                        return `
                        <div class="stock-item-row" data-item-id="${item.id}" data-cost-per-piece="${costPerPiece}" data-max-pieces="${totalPieces}">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 gap-2">
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800">${item.productName}</h3>
                                    <p class="text-xs text-gray-600">${item.sheetType} - ${item.stickerType}</p>
                                </div>
                                <div class="text-left sm:text-right">
                                    <p class="text-sm text-gray-600">Available: <span class="font-bold text-blue-600">${totalPieces} pcs</span></p>
                                    <p class="text-sm text-gray-600">Value: <span class="font-bold text-green-600">‚Çπ${totalValue.toFixed(2)}</span></p>
                                </div>
                            </div>

                            <div class="flex items-center gap-3">
                                <input
                                    type="number"
                                    class="stock-out-input flex-1 px-3 py-2 rounded-lg text-sm"
                                    placeholder="Pieces to remove"
                                    min="0"
                                    max="${totalPieces}"
                                    data-item-id="${item.id}"
                                    oninput="updateStockOutCalculation()"
                                />
                                <div class="text-right min-w-24">
                                    <p class="text-xs text-gray-500">Value:</p>
                                    <p class="item-value-display font-bold text-red-600">‚Çπ0.00</p>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>

                <div class="mb-6 p-6 rounded-xl" style="background: #fee2e2; border: 2px solid #ef4444;">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-1">Total Value to Remove</p>
                            <p id="total-value-to-remove" class="text-3xl font-bold text-red-600">‚Çπ0.00</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-1">New Stock Value</p>
                            <p id="new-stock-value" class="text-3xl font-bold text-green-600">‚Çπ${currentTotalValue.toFixed(2)}</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                        Cancel
                    </button>
                    <button id="processStockOutBtn" onclick="processStockOut()" class="btn-danger flex-1 text-white py-3 rounded-xl font-semibold text-lg">
                        üì§ Process Stock Out
                    </button>
                </div>
            </div>
            `;
            document.body.appendChild(modal);
        }

        // Calculate stock out values in real-time
        function updateStockOutCalculation() {
            const currentTotalValue = calculateTotalStockValue();
            let totalValueToRemove = 0;

            const inputs = document.querySelectorAll('.stock-out-input');
            inputs.forEach(input => {
                const itemId = input.dataset.itemId;
                const row = document.querySelector(`.stock-item-row[data-item-id="${itemId}"]`);
                if (!row) return;
                
                const costPerPiece = parseFloat(row.dataset.costPerPiece);
                const maxPieces = parseInt(row.dataset.maxPieces);
                let piecesToRemove = parseInt(input.value) || 0;

                if (piecesToRemove > maxPieces) {
                    piecesToRemove = maxPieces;
                    input.value = maxPieces;
                }
                if (piecesToRemove < 0) {
                    piecesToRemove = 0;
                    input.value = 0;
                }

                const valueToRemove = costPerPiece * piecesToRemove;
                totalValueToRemove += valueToRemove;

                const valueDisplay = row.querySelector('.item-value-display');
                if(valueDisplay) {
                    valueDisplay.textContent = `‚Çπ${valueToRemove.toFixed(2)}`;
                }
            });

            const newStockValue = currentTotalValue - totalValueToRemove;

            const totalValueEl = document.getElementById('total-value-to-remove');
            const newStockValueEl = document.getElementById('new-stock-value');
            
            if(totalValueEl) {
                totalValueEl.textContent = `‚Çπ${totalValueToRemove.toFixed(2)}`;
            }
            if(newStockValueEl) {
                newStockValueEl.textContent = `‚Çπ${newStockValue.toFixed(2)}`;
            }
        }

        // Process all stock out operations (Supabase)
        async function processStockOut() {
            const processButton = document.getElementById('processStockOutBtn');
            if(processButton) {
                processButton.textContent = 'Processing...';
                processButton.disabled = true;
            }

            const inputs = document.querySelectorAll('.stock-out-input');
            let processedCount = 0;
            let totalValueRemoved = 0;
            let hasErrors = false;
            
            const updatePromises = [];

            for (const input of inputs) {
                const piecesToRemove = parseInt(input.value) || 0;
                if (piecesToRemove === 0) continue;

                const itemId = input.dataset.itemId;
                const item = allData.find(d => d.id == itemId);
                if (!item) continue;

                const currentTotalPieces = item.pieces;

                if (piecesToRemove > currentTotalPieces) {
                    showToast(`Cannot remove ${piecesToRemove} pieces from ${item.productName}. Only ${currentTotalPieces} available! ‚ùå`, 'error');
                    hasErrors = true;
                    continue;
                }

                const costPerPiece = item.piecesPerSheet > 0 ? item.costPerSheet / item.piecesPerSheet : 0;
                const valueRemoved = costPerPiece * piecesToRemove;

                const remainingPieces = currentTotalPieces - piecesToRemove;
                const newTotalCost = remainingPieces * costPerPiece; // Recalculate total cost

                // Add update to promise array
                updatePromises.push(
                    supabaseClient
                        .from('inventory')
                        .update({ pieces: remainingPieces, total_cost: newTotalCost })
                        .eq('id', itemId)
                );
                
                // Add history logging to promise array
                updatePromises.push(
                    logHistory(itemId, item.productName, 'stock_out', piecesToRemove, currentTotalPieces, remainingPieces, valueRemoved)
                );
                
                processedCount++;
                totalValueRemoved += valueRemoved;
            }

            if (hasErrors) {
                showToast('Errors found. Please correct quantities.', 'error');
                if(processButton) {
                    processButton.textContent = 'üì§ Process Stock Out';
                    processButton.disabled = false;
                }
                return;
            }

            if (updatePromises.length > 0) {
                await Promise.all(updatePromises);
                document.querySelector('.modal-backdrop')?.remove();
                showToast(`Successfully removed stock from ${processedCount} items! Total value deducted: ‚Çπ${totalValueRemoved.toFixed(2)} üì§`, 'success');
                await loadData();
                renderCurrentView();
            } else {
                showToast('No items were processed', 'info');
                if(processButton) {
                    processButton.textContent = 'üì§ Process Stock Out';
                    processButton.disabled = false;
                }
            }
        }

        // --- Quick Actions from Card (Supabase) ---

        async function quickStockOut(itemId) {
            const item = allData.find(d => d.id == itemId);
            if (!item) return;

            const totalPieces = item.pieces;

            if (totalPieces === 0) {
                showToast('This item is already out of stock! üö´', 'error');
                return;
            }

            const valueRemoved = item.totalCost; // Removing all, so value removed is total cost

            const { error } = await supabaseClient
                .from('inventory')
                .update({ pieces: 0, total_cost: 0 }) // Set to 0
                .eq('id', itemId);

            if (error) {
                showToast(`Failed to remove stock: ${error.message}`, 'error');
            } else {
                await logHistory(itemId, item.productName, 'stock_out', totalPieces, totalPieces, 0, valueRemoved);
                showToast(`All ${totalPieces} pieces removed (‚Çπ${valueRemoved.toFixed(2)})! Item now out of stock üö´`, 'success');
                await loadData();
                renderCurrentView();
            }
        }
        async function stockInItem(itemId) {
            const item = allData.find(d => d.id == itemId);
            if (!item) return;

            const costPerPiece = item.piecesPerSheet > 0 ? item.costPerSheet / item.piecesPerSheet : 0;

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üì• Stock In</h2>
                <p class="text-gray-600 mb-2">Add pieces to <strong>${item.productName}</strong></p>
                <p class="text-sm text-gray-500 mb-6">Cost per piece: ‚Çπ${costPerPiece.toFixed(2)}</p>
                <form onsubmit="confirmStockIn(event, '${itemId}')" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Number of Pieces to Add *</label>
                        <input type="number" id="stock-in-quantity" min="1" class="w-full px-4 py-3 rounded-xl" required oninput="updateStockInCost(${costPerPiece})" />
                    </div>
                    <div id="stock-in-cost-display" class="p-4 rounded-xl" style="background: #f0fdf4; border: 2px solid #10b981;">
                        <p class="text-sm text-gray-600 mb-1">Total Cost:</p>
                        <p class="text-2xl font-bold text-green-600">‚Çπ0.00</p>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                            Cancel
                        </button>
                        <button type="submit" class="btn-success flex-1 text-white py-3 rounded-xl font-semibold">
                            Add Stock
                        </button>
                    </div>
                </form>
            </div>
            `;
            document.body.appendChild(modal);
        }

        function updateStockInCost(costPerPiece) {
             const quantityInput = document.getElementById('stock-in-quantity');
             const pieces = parseInt(quantityInput.value) || 0;
             const totalCost = pieces * costPerPiece;
             const display = document.getElementById('stock-in-cost-display');
             if(display) {
                display.innerHTML = `
                    <p class="text-sm text-gray-600 mb-1">Total Cost:</p>
                    <p class="text-2xl font-bold text-green-600">‚Çπ${totalCost.toFixed(2)}</p>
                `;
             }
        }

        async function confirmStockIn(event, itemId) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.textContent = 'Adding...';
            submitButton.disabled = true;
            
            const piecesToAdd = parseInt(document.getElementById('stock-in-quantity').value);
            const item = allData.find(d => d.id == itemId);
            if (!item) return;
            
            if (piecesToAdd <= 0) {
                showToast('Please enter a valid quantity', 'error');
                submitButton.textContent = 'Add Stock';
                submitButton.disabled = false;
                return;
            }

            const costPerPiece = item.piecesPerSheet > 0 ? item.costPerSheet / item.piecesPerSheet : 0;
            const valueAdded = costPerPiece * piecesToAdd;

            const beforePieces = item.pieces;
            const newTotalPieces = item.pieces + piecesToAdd;
            const newTotalCost = item.totalCost + valueAdded;

            const { error } = await supabaseClient
                .from('inventory')
                .update({ pieces: newTotalPieces, total_cost: newTotalCost })
                .eq('id', itemId);

            if (error) {
                showToast(`Failed to add stock: ${error.message}`, 'error');
                submitButton.textContent = 'Add Stock';
                submitButton.disabled = false;
            } else {
                await logHistory(itemId, item.productName, 'stock_in', piecesToAdd, beforePieces, newTotalPieces, valueAdded);
                showToast(`Added ${piecesToAdd} pieces (‚Çπ${valueAdded.toFixed(2)}) successfully! üì•`, 'success');
                document.querySelector('.modal-backdrop')?.remove();
                await loadData();
                renderCurrentView();
            }
        }

        async function stockOutItem(itemId) {
            const item = allData.find(d => d.id == itemId);
            if (!item) return;

            const totalPieces = item.pieces;
            const costPerPiece = item.piecesPerSheet > 0 ? item.costPerSheet / item.piecesPerSheet : 0;

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üì§ Stock Out</h2>
                <p class="text-gray-600 mb-2">Remove pieces from <strong>${item.productName}</strong></p>
                <p class="text-sm text-gray-500 mb-6">Available: ${totalPieces} pieces</p>
                <form onsubmit="confirmStockOut(event, '${itemId}')" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Number of Pieces to Remove *</label>
                        <input type="number" id="stock-out-quantity-modal" min="1" max="${totalPieces}" class="w-full px-4 py-3 rounded-xl" required oninput="updateStockOutCost(${costPerPiece})" />
                    </div>
                    <div id="stock-out-value-display" class="p-4 rounded-xl" style="background: #fef2f2; border: 2px solid #ef4444;">
                        <p class="text-sm text-gray-600 mb-1">Value Being Removed:</p>
                        <p class="text-2xl font-bold text-red-600">‚Çπ0.00</p>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                            Cancel
                        </button>
                        <button type="submit" class="btn-danger flex-1 text-white py-3 rounded-xl font-semibold">
                            Remove Stock
                        </button>
                    </div>
                </form>
            </div>
            `;
            document.body.appendChild(modal);
        }

        function updateStockOutCost(costPerPiece) {
            const quantityInput = document.getElementById('stock-out-quantity-modal');
            const pieces = parseInt(quantityInput.value) || 0;
            const totalValue = pieces * costPerPiece;
            const display = document.getElementById('stock-out-value-display');
            if(display) {
                display.innerHTML = `
                    <p class="text-sm text-gray-600 mb-1">Value Being Removed:</p>
                    <p class="text-2xl font-bold text-red-600">‚Çπ${totalValue.toFixed(2)}</p>
                `;
            }
        }


        async function confirmStockOut(event, itemId) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.textContent = 'Removing...';
            submitButton.disabled = true;
            
            const piecesToRemove = parseInt(document.getElementById('stock-out-quantity-modal').value);
            const item = allData.find(d => d.id == itemId);
            if (!item) return;

            const currentTotalPieces = item.pieces;

            if (piecesToRemove <= 0) {
                showToast('Please enter a valid quantity', 'error');
                submitButton.textContent = 'Remove Stock';
                submitButton.disabled = false;
                return;
            }

            if (piecesToRemove > currentTotalPieces) {
                showToast(`Cannot remove ${piecesToRemove} pieces. Only ${currentTotalPieces} pieces available! ‚ùå`, 'error');
                submitButton.textContent = 'Remove Stock';
                submitButton.disabled = false;
                return;
            }

            const costPerPiece = item.piecesPerSheet > 0 ? item.costPerSheet / item.piecesPerSheet : 0;
            const valueRemoved = costPerPiece * piecesToRemove;

            const remainingPieces = currentTotalPieces - piecesToRemove;
            const newTotalCost = item.totalCost - valueRemoved;

            const { error } = await supabaseClient
                .from('inventory')
                .update({ pieces: remainingPieces, total_cost: newTotalCost })
                .eq('id', itemId);

            if (error) {
                showToast(`Failed to remove stock: ${error.message}`, 'error');
                submitButton.textContent = 'Remove Stock';
                submitButton.disabled = false;
            } else {
                await logHistory(itemId, item.productName, 'stock_out', piecesToRemove, currentTotalPieces, remainingPieces, valueRemoved);
                showToast(`Removed ${piecesToRemove} pieces (‚Çπ${valueRemoved.toFixed(2)}) successfully! üì§`, 'success');
                document.querySelector('.modal-backdrop')?.remove();
                await loadData();
                renderCurrentView();
            }
        }

        // --- Edit & Delete Stock (Supabase) ---

        function deleteStockItem(itemId) {
            const item = allData.find(d => d.id == itemId);
            if (!item) return;
            
            // The new file has logic for multiple stock entries, but our schema
            // (one item per product/type/vendor) doesn't. We'll use the simpler delete.
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üóëÔ∏è Confirm Delete</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to delete <strong>${item.productName}</strong>? This will also delete all transaction history. This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                        Cancel
                    </button>
                    <button id="confirmDeleteStockBtn" onclick="confirmDeleteStock('${itemId}')" class="btn-danger flex-1 text-white py-3 rounded-xl font-semibold">
                        Delete
                    </button>
                </div>
            </div>
            `;
            document.body.appendChild(modal);
        }

        async function confirmDeleteStock(itemId) {
            const deleteButton = document.getElementById('confirmDeleteStockBtn');
            if(deleteButton) {
                deleteButton.textContent = 'Deleting...';
                deleteButton.disabled = true;
            }

            // We must delete from transactions first
            const { error: transError } = await supabaseClient
                .from('transactions')
                .delete()
                .eq('product_id', itemId);
                
            if (transError) {
                showToast(`Failed to delete history: ${transError.message}`, 'error');
                if(deleteButton) {
                    deleteButton.textContent = 'Delete';
                    deleteButton.disabled = false;
                }
                return;
            }
            
            // Then delete from inventory
            const { error: invError } = await supabaseClient
                .from('inventory')
                .delete()
                .eq('id', itemId);

            if (invError) {
                showToast(`Failed to delete stock item: ${invError.message}`, 'error');
                if(deleteButton) {
                    deleteButton.textContent = 'Delete';
                    deleteButton.disabled = false;
                }
            } else {
                showToast('Stock item and history deleted successfully! üóëÔ∏è', 'success');
                document.querySelector('.modal-backdrop')?.remove();
                await loadData();
                renderCurrentView();
            }
        }

        function editStockItem(itemId) {
            const item = allData.find(d => d.id == itemId);
            if (!item) return;
            const vendors = allData.filter(d => d.type === 'vendor');

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-3xl w-full my-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">‚úèÔ∏è Edit Stock Item</h2>
                <form onsubmit="updateStockItem(event, '${itemId}')" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Product Name *</label>
                            <input type="text" id="edit-product-name" value="${item.productName}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Date *</label>
                            <input type="date" id="edit-stock-date" value="${item.date}" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Sheet Type *</label>
                            <select id="edit-sheet-type" class="w-full px-4 py-3 rounded-xl" required>
                                ${sheetTypeVariants.map(type => `<option value="${type}" ${item.sheetType === type ? 'selected' : ''}>${type}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Sticker Type *</label>
                            <select id="edit-sticker-type" class="w-full px-4 py-3 rounded-xl" required>
                                ${stickerTypeVariants.map(type => `<option value="${type}" ${item.stickerType === type ? 'selected' : ''}>${type}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Total Pieces *</label>
                            <input type="number" id="edit-total-pieces" value="${item.pieces}" class="w-full px-4 py-3 rounded-xl" min="0" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Pieces per Sheet *</label>
                            <input type="number" id="edit-pieces-per-sheet" value="${item.piecesPerSheet}" class="w-full px-4 py-3 rounded-xl" min="1" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Cost per Sheet *</label>
                            <input type="number" id="edit-cost-per-sheet" value="${item.costPerSheet}" class="w-full px-4 py-3 rounded-xl" min="0" step="0.01" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Vendor *</label>
                            <select id="edit-stock-vendor" class="w-full px-4 py-3 rounded-xl" required>
                                ${vendors.map(v => `<option value="${v.vendorName}" ${item.vendor === v.vendorName ? 'selected' : ''}>${v.vendorName}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary flex-1 text-white py-3 rounded-xl font-semibold">
                            Update Stock
                        </button>
                    </div>
                </form>
            </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateStockItem(event, itemId) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.textContent = 'Updating...';
            submitButton.disabled = true;
            
            const item = allData.find(d => d.id == itemId);
            if (!item) return;

            // Get new values
            const newPieces = parseInt(document.getElementById('edit-total-pieces').value);
            const newPiecesPerSheet = parseInt(document.getElementById('edit-pieces-per-sheet').value);
            const newCostPerSheet = parseFloat(document.getElementById('edit-cost-per-sheet').value);
            
            // Recalculate total_cost
            const costPerPiece = newPiecesPerSheet > 0 ? newCostPerSheet / newPiecesPerSheet : 0;
            const newTotalCost = newPieces * costPerPiece;

            const updatedItem = {
                name: document.getElementById('edit-product-name').value,
                date_added: document.getElementById('edit-stock-date').value,
                sheet_type: document.getElementById('edit-sheet-type').value,
                sticker_type: document.getElementById('edit-sticker-type').value,
                pieces: newPieces,
                pieces_per_sheet: newPiecesPerSheet,
                cost_per_sheet: newCostPerSheet,
                total_cost: newTotalCost,
                vendor: document.getElementById('edit-stock-vendor').value
            };

            const { error } = await supabaseClient
                .from('inventory')
                .update(updatedItem)
                .eq('id', itemId);

            if (error) {
                showToast(`Failed to update stock item: ${error.message}`, 'error');
                submitButton.textContent = 'Update Stock';
                submitButton.disabled = false;
            } else {
                showToast('Stock item updated successfully! ‚úÖ', 'success');
                document.querySelector('.modal-backdrop')?.remove();
                
                // Update transaction product_name if it changed
                if (item.productName !== updatedItem.name) {
                     await supabaseClient
                        .from('transactions')
                        .update({ product_name: updatedItem.name })
                        .eq('product_id', itemId);
                }
                
                await loadData();
                renderCurrentView();
            }
        }

        // --- History View (Adapted for Supabase) ---

        async function viewHistory(itemId) {
            const item = allData.find(d => d.id == itemId);
            if (!item) return;

            // Fetch fresh history from Supabase
            const { data: historyRecords, error } = await supabaseClient
                .from('transactions')
                .select('*')
                .eq('product_id', itemId)
                .order('date', { ascending: false })
                .order('time', { ascending: false });

            if (error) {
                showToast(`Failed to load history: ${error.message}`, 'error');
                return;
            }

            const config = getConfig();
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-6 overflow-y-auto';
            modal.innerHTML = `
            <div class="glass-card p-4 sm:p-8 max-w-3xl w-full my-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">üìú Stock History</h2>
                    <button onclick="this.closest('.modal-backdrop').remove()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>

                <div class="mb-6 p-6 rounded-xl" style="background: #f8f9fa; border-left: 5px solid ${config.primary_color || defaultConfig.primary_color}">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${item.productName}</h3>
                    <p class="text-gray-600 text-sm">${item.sheetType} - ${item.stickerType}</p>
                </div>

                ${historyRecords.length > 0 ? `
                <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    ${historyRecords.map(record => {
                        const isStockIn = record.type === 'Stock In';
                        const icon = isStockIn ? 'üì•' : 'üì§';
                        const actionColor = isStockIn ? '#10b981' : '#ef4444';
                        const actionText = record.type;
                        const valueChange = record.cost || 0;
                        const timestamp = new Date(record.date + ' ' + record.time);
                        const timeString = timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        const dateString = timestamp.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                        return `
                        <div class="p-6 rounded-2xl relative" style="background: linear-gradient(135deg, ${isStockIn ? '#f0fdf4' : '#fef2f2'}, white); border: 2px solid ${actionColor}; box-shadow: 0 4px 15px rgba(0,0,0,0.1)">
                            <button onclick="deleteHistoryRecord('${record.id}', '${itemId}')" class="absolute top-3 right-3 w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 text-lg font-bold transition-colors rounded-full hover:bg-red-50" title="Delete History">
                                ‚úï
                            </button>

                            <div class="flex items-start gap-4 mb-4 pr-8">
                                <div class="flex-shrink-0 w-14 h-14 rounded-full flex items-center justify-center text-3xl" style="background: ${actionColor}20;">
                                    ${icon}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-bold text-gray-800 text-xl">${actionText}</span>
                                    </div>
                                    <div class="flex items-center gap-3 text-sm text-gray-600">
                                        <span class="flex items-center gap-1 font-semibold">
                                            üïê ${timeString}
                                        </span>
                                        <span class="flex items-center gap-1 font-semibold">
                                            üìÖ ${dateString}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div class="p-3 rounded-lg" style="background: white; border: 1px solid #e5e7eb;">
                                    <p class="text-xs text-gray-500 mb-1">Quantity Changed</p>
                                    <p class="text-lg font-bold" style="color: ${actionColor}">${isStockIn ? '+' : '-'}${record.quantity} pieces</p>
                                </div>
                                <div class="p-3 rounded-lg" style="background: white; border: 1px solid #e5e7eb;">
                                    <p class="text-xs text-gray-500 mb-1">Value Impact</p>
                                    <p class="text-lg font-bold" style="color: ${actionColor}">${isStockIn ? '+' : '-'}‚Çπ${valueChange.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
                ` : `
                <div class="text-center py-16">
                    <span class="text-8xl mb-6 block">üìã</span>
                    <p class="text-gray-600 text-xl">No history records yet</p>
                    <p class="text-gray-500 text-sm mt-2">Stock movements will appear here</p>
                </div>
                `}

                <div class="mt-6">
                    <button onclick="this.closest('.modal-backdrop').remove()" class="btn-primary w-full text-white py-4 rounded-xl font-semibold text-lg">
                        Close
                    </button>
                </div>
            </div>
            `;
            document.body.appendChild(modal);
        }
        async function deleteHistoryRecord(historyId, stockId) {
            const modal = document.createElement('div');
            // Ensure this new modal appears on top
            modal.style.zIndex = '9999'; 
            modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
            <div class="glass-card p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üóëÔ∏è Confirm Delete</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this history record? This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                        Cancel
                    </button>
                    <button id="confirmDeleteHistoryBtn" onclick="confirmDeleteHistory('${historyId}', '${stockId}')" class="btn-danger flex-1 text-white py-3 rounded-xl font-semibold">
                        Delete
                    </button>
                </div>
            </div>
            `;
            // We must append to the body, not the existing modal
            document.body.appendChild(modal);
        }

        async function confirmDeleteHistory(historyId, stockId) {
            const deleteButton = document.getElementById('confirmDeleteHistoryBtn');
            if(deleteButton) {
                deleteButton.textContent = 'Deleting...';
                deleteButton.disabled = true;
            }

            const { error } = await supabaseClient
                .from('transactions')
                .delete()
                .eq('id', historyId);

            if (error) {
                showToast(`Failed to delete history: ${error.message}`, 'error');
                if(deleteButton) {
                    deleteButton.textContent = 'Delete';
                    deleteButton.disabled = false;
                }
            } else {
                showToast('History record deleted successfully! üóëÔ∏è', 'success');
                // Remove all modals
                document.querySelectorAll('.modal-backdrop').forEach(m => m.remove()); 
                await loadData(); // Reload data
                viewHistory(stockId); // Re-open the history modal
            }
        }

        // --- UI Utilities (from new file) ---

        function handleSheetTypeChange() {
            const select = document.getElementById('sheet-type');
            if (select.value === '__add_new__') {
                const modal = document.createElement('div');
                modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
                modal.style.zIndex = '9999';
                modal.innerHTML = `
                <div class="glass-card p-8 max-w-md w-full">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">‚ûï Add New Sheet Type</h2>
                    <form onsubmit="addNewSheetType(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Sheet Type Name *</label>
                            <input type="text" id="new-sheet-type" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="this.closest('.modal-backdrop').remove(); document.getElementById('sheet-type').value = '';" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                                Cancel
                            </button>
                            <button type="submit" class="btn-success flex-1 text-white py-3 rounded-xl font-semibold">
                                Add
                            </button>
                        </div>
                    </form>
                </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function addNewSheetType(event) {
            event.preventDefault();
            const newVariant = document.getElementById('new-sheet-type').value.trim();
            if (newVariant && !sheetTypeVariants.includes(newVariant)) {
                sheetTypeVariants.push(newVariant);
                document.querySelector('.modal-backdrop')?.remove();
                renderCurrentView(); // Re-render the 'stock-in' page
                setTimeout(() => {
                    // Set the value after re-render
                    if(document.getElementById('sheet-type')) {
                        document.getElementById('sheet-type').value = newVariant;
                    }
                }, 0);
            } else if (sheetTypeVariants.includes(newVariant)) {
                showToast('This sheet type already exists', 'error');
            }
        }

        function handleStickerTypeChange() {
            const select = document.getElementById('sticker-type');
            if (select.value === '__add_new__') {
                const modal = document.createElement('div');
                modal.className = 'modal-backdrop fixed inset-0 flex items-center justify-center z-50 p-4';
                modal.style.zIndex = '9999';
                modal.innerHTML = `
                <div class="glass-card p-8 max-w-md w-full">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">‚ûï Add New Sticker Type</h2>
                    <form onsubmit="addNewStickerType(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Sticker Type Name *</label>
                            <input type="text" id="new-sticker-type" class="w-full px-4 py-3 rounded-xl" required />
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="this.closest('.modal-backdrop').remove(); document.getElementById('sticker-type').value = '';" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e5e7eb; color: #374151;">
                                Cancel
                            </button>
                            <button type="submit" class="btn-success flex-1 text-white py-3 rounded-xl font-semibold">
                                Add
                            </button>
                        </div>
                    </form>
                </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function addNewStickerType(event) {
            event.preventDefault();
            const newVariant = document.getElementById('new-sticker-type').value.trim();
            if (newVariant && !stickerTypeVariants.includes(newVariant)) {
                stickerTypeVariants.push(newVariant);
                document.querySelector('.modal-backdrop')?.remove();
                renderCurrentView(); // Re-render the 'stock-in' page
                setTimeout(() => {
                    // Set the value after re-render
                     if(document.getElementById('sticker-type')) {
                        document.getElementById('sticker-type').value = newVariant;
                     }
                }, 0);
            } else if (stickerTypeVariants.includes(newVariant)) {
                showToast('This sticker type already exists', 'error');
            }
        }

        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);

            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
            }
        }

        function showToast(message, type = 'success') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(t => t.remove());
            
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)';
            toast.className = 'toast px-8 py-4 rounded-xl shadow-2xl';
            toast.style.background = bgColor;
            toast.innerHTML = `
                <p class="text-white font-semibold text-lg">${message}</p>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add slideOut animation to CSS
        document.styleSheets[0].insertRule(`
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `, document.styleSheets[0].cssRules.length);


        // --- Start the App ---
        initApp();
        
    </script>
</body>
</html>